
require RiggingToolbox;
require InlineDrawing;

operator entry(){

  StartFabricProfiling();

  GeometryStack stack();
  stack.loadJSONFile("${FABRIC_RIGGINGTOOLBOX_PATH}/Tests/GeometryStack/Resources/tubeCharacter_Skinning.json");

  SkinningModifier skiningModifier = stack.getGeometryOperator(1);


  EvalContext context();
  GeometrySet geomSet = stack.evaluate(context);

  {
    // Modify the pose and then reevaluate. 
    Mat44 pose[];
    pose.resize(4);
    pose[0] = Xfo(Vec3(3, 4, 5)).toMat44();
    pose[1] = Xfo(Vec3(10, 20, 5)).toMat44();
    skiningModifier.setPose(pose);
  }

  stack.evaluate(context);

  {
    // Modify the pose again and then reevaluate. 
    Mat44 pose[];
    pose.resize(4);
    pose[0] = Xfo(Vec3(1, 2, 3)).toMat44();
    pose[1] = Xfo(Vec3(4, 6, 7)).toMat44();
    skiningModifier.setPose(pose);
  }

  stack.evaluate(context);

  StopFabricProfiling();

  report( GetEvalPathReport() );

  Boolean testDrawingPipeline = false;
  DrawContext drawContext = null;
  InlineDrawingScope inlineDrawingScope = null;
  if(testDrawingPipeline){
    drawContext = DrawContext();
    inlineDrawingScope = InlineDrawingScope();
    inlineDrawingScope.draw(drawContext);
  }


  {
    // Modify the pose again and then reevaluate. 
    Mat44 pose[];
    pose.resize(4);
    pose[0] = Xfo(Vec3(4, 7, 13)).toMat44();
    pose[1] = Xfo(Vec3(14, 16, 17)).toMat44();
    skiningModifier.setPose(pose);
  }
  
  stack.evaluate(context);
  
  if(testDrawingPipeline)
    inlineDrawingScope.draw(drawContext);
}

